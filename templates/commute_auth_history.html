{% extends "base.html" %}

{% block title %}나의 출근인증 이력{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-3xl mx-auto">
  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">나의 출근인증 이력</h2>

  <form id="deleteForm" action="{{ url_for('delete_commute_auth_selected') }}" method="post">
    {% if reports %}
      <ul class="space-y-4">
        {% for report in reports %}
          <li class="flex items-start bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
            <input type="checkbox" name="delete_ids" value="{{ report.id }}" class="mt-1 mr-4 h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
            <div class="flex-1">
              <p class="text-sm text-gray-500 mb-1">
                {{ report.timestamp.strftime('%Y-%m-%d %H:%M') }} 
                {% if report.is_late %}<span class="text-red-600 font-bold ml-2"> (지각)</span>{% endif %}
                {% if report.is_holiday %}<span class="text-green-600 font-bold ml-2"> (휴무)</span>{% endif %}
              </p>
              <p class="text-gray-800 leading-relaxed">{{ report.content }}</p>
            </div>
          </li>
        {% endfor %}
      </ul>
      <div class="mt-8 text-center">
        <button type="button" id="deleteButton"
                class="px-8 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md">
          선택 삭제
        </button>
      </div>
    {% else %}
      <p class="text-center text-gray-600 text-lg">제출된 출근인증이 없습니다.</p>
    {% endif %}
  </form>

  <div class="mt-8 text-center space-x-4">
    <a href="{{ url_for('home') }}" class="inline-block text-blue-600 hover:underline font-medium">홈으로</a>
    <a href="{{ url_for('logout') }}" class="inline-block text-red-600 hover:underline font-medium">로그아웃</a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DEBUG: DOMContentLoaded fired in commute_auth_history.html'); // DEBUG
    const deleteButton = document.getElementById('deleteButton');
    const deleteForm = document.getElementById('deleteForm');

    if (deleteButton) {
      console.log('DEBUG: deleteButton found.'); // DEBUG
      deleteButton.addEventListener('click', (event) => {
        event.preventDefault(); // 기본 폼 제출 방지
        console.log('DEBUG: Delete button clicked.'); // DEBUG

        const checkboxes = document.querySelectorAll('input[name="delete_ids"]:checked');
        console.log('DEBUG: Checked checkboxes count:', checkboxes.length); // DEBUG

        if (checkboxes.length === 0) {
          console.log('DEBUG: No checkboxes selected. Showing alert modal.'); // DEBUG
          window.showConfirmModal('삭제할 이력을 선택해주세요.', () => {
            console.log('DEBUG: "삭제할 이력을 선택해주세요." modal closed.'); // DEBUG
          }); 
          return;
        }

        // DEBUG: 모달을 건너뛰고 직접 폼 제출을 시도하려면 아래 줄의 주석을 해제하세요.
        // deleteForm.submit(); 
        // console.log('DEBUG: Form submitted directly (bypassing modal for debug).'); // DEBUG
        // return; // 직접 제출 후 함수 종료

        console.log('DEBUG: Checkboxes selected. Showing confirmation modal.'); // DEBUG
        window.showConfirmModal('선택한 이력을 삭제하시겠습니까?', (confirmed) => {
          console.log('DEBUG: Confirmation modal callback invoked. Confirmed:', confirmed); // DEBUG
          if (confirmed) {
            deleteForm.submit(); 
            console.log('DEBUG: Form submitted after confirmation.'); // DEBUG
          } else {
            console.log('DEBUG: Form submission cancelled by user.'); // DEBUG
          }
        });
      });
    } else {
      console.error('ERROR: deleteButton not found!'); // DEBUG
    }
  });
</script>
{% endblock %}

