{% extends "base.html" %}

{% block title %}제출 이력{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-3xl mx-auto">
  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">나의 제출 이력</h2>

  <form id="deleteForm" action="/delete_selected" method="post">
    {% if reports %}
      <ul class="space-y-4">
        {% for report in reports %}
          <li class="flex items-start bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
            <input type="checkbox" name="delete_ids" value="{{ report.id }}" class="mt-1 mr-4 h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
            <div class="flex-1">
              <p class="text-sm text-gray-500 mb-1">{{ report.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
              <p class="text-gray-800 leading-relaxed">{{ report.content }}</p>
              {% if report.image_filename %}
                <div class="mt-3">
                  <img src="{{ url_for('uploaded_file', filename=report.image_filename) }}" 
                       alt="첨부 이미지" 
                       class="max-w-full h-auto rounded-lg shadow-md border border-gray-200"
                       onerror="this.onerror=null; this.src='https://placehold.co/150x100/cccccc/333333?text=Image+Not+Found';"
                  >
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
      <div class="mt-8 text-center">
        <button type="button" id="deleteButton"
                class="px-8 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md">
          선택 삭제
        </button>
      </div>
    {% else %}
      <p class="text-center text-gray-600 text-lg">제출된 보고서가 없습니다.</p>
    {% endif %}
  </form>

  <div class="mt-8 text-center space-x-4">
    <a href="/" class="inline-block text-blue-600 hover:underline font-medium">홈으로</a>
    <a href="/logout" class="inline-block text-red-600 hover:underline font-medium">로그아웃</a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deleteButton = document.getElementById('deleteButton');
    const deleteForm = document.getElementById('deleteForm');

    if (deleteButton) {
      deleteButton.addEventListener('click', (event) => {
        event.preventDefault(); // 기본 폼 제출 방지

        const checkboxes = document.querySelectorAll('input[name="delete_ids"]:checked');
        if (checkboxes.length === 0) {
          window.showConfirmModal('삭제할 이력을 선택해주세요.', (confirmed) => {
            // 아무것도 안 해도 됨, 그냥 알림용 모달
          });
          return;
        }

        window.showConfirmModal('선택한 이력을 삭제하시겠습니까?', (confirmed) => {
          if (confirmed) {
            deleteForm.submit(); // 사용자가 확인하면 폼 제출
          }
        });
      });
    }
  });
</script>
{% endblock %}

