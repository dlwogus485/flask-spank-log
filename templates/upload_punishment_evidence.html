{% extends "base.html" %}

{% block title %}증거 업로드{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl mx-auto">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">체벌/교육 증거 업로드</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <div class="p-3 rounded-lg text-sm {% if category == 'success' %}bg-green-100 text-green-700{% elif category == 'error' %}bg-red-100 text-red-700{% elif category == 'warning' %}bg-yellow-100 text-yellow-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# schedule_id가 URL에 없는 경우 (일정 목록 보여주기) #}
    {% if schedule_id is none %} {# schedule_id가 None일 때 목록 표시 #}
        <p class="text-gray-700 text-lg mb-4 text-center">증거를 업로드할 체벌/교육 일정을 선택해주세요.</p>
        <div class="space-y-4 mb-8">
            {% if schedules %}
                {% for schedule_item in schedules %} {# schedule_item으로 변수명 변경 #}
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                        <div>
                            <p class="text-gray-700 font-medium">
                                <strong>요청일시:</strong> {{ schedule_item.requested_datetime.strftime('%Y년 %m월 %d일 %H시 %M분') }}
                            </p>
                            {% if schedule_item.approved_datetime %}
                                <p class="text-gray-700 text-sm mt-1">
                                    <strong>확정일시:</strong> {{ datetime.fromisoformat(schedule_item.approved_datetime).strftime('%Y년 %m월 %d일 %H시 %M분') }}
                                </p>
                            {% endif %}
                            <p class="text-gray-800 mt-1"><strong>사유:</strong> {{ schedule_item.reason }}</p>
                            <p class="text-gray-700 text-sm mt-1"><strong>상태:</strong> {{ schedule_item.status }}</p>
                        </div>
                        <div>
                            {# 관리자는 목록 페이지에서 업로드 버튼을 보지 않고, 증거 보기만 가능 #}
                            {% if user_role == 'sub' %}
                                {% if schedule_item.status == 'approved' or schedule_item.status == 'rescheduled' %}
                                    <a href="{{ url_for('upload_punishment_evidence', schedule_id=schedule_item.id) }}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-300 text-sm">
                                        증거 업로드
                                    </a>
                                {% elif schedule_item.status == 'evidence_uploaded' %}
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
                                        증거 업로드 완료
                                    </span>
                                    <a href="{{ url_for('upload_punishment_evidence', schedule_id=schedule_item.id) }}" class="text-blue-500 hover:underline text-sm ml-2">
                                        증거 보기
                                    </a>
                                {% else %}
                                    <span class="px-3 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">
                                        업로드 불가
                                    </span>
                                {% endif %}
                            {% elif user_role == 'owner' and schedule_item.status == 'evidence_uploaded' %}
                                <a href="{{ url_for('upload_punishment_evidence', schedule_id=schedule_item.id) }}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 text-sm">
                                    증거 보기
                                </a>
                            {% else %}
                                <span class="px-3 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">
                                    해당 없음
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="bg-yellow-100 p-4 rounded-lg text-yellow-700 text-center font-medium">
                    현재 증거를 업로드할 수 있는 체벌/교육 일정이 없습니다.
                </div>
            {% endif %}
        </div>
    {# schedule_id가 URL에 있는 경우 (특정 일정에 대한 업로드 폼 또는 증거 보기) #}
    {% elif schedule %}
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-3">선택된 체벌/교육 일정</h3>
            <p class="text-gray-700 text-sm mb-2"><strong>요청일시:</strong> {{ schedule.requested_datetime.strftime('%Y년 %m월 %d일 %H시 %M분') }}</p>
            {% if schedule.approved_datetime %}
                <p class="text-gray-700 text-sm mb-2"><strong>확정일시:</strong> {{ schedule.approved_datetime.strftime('%Y년 %m월 %d일 %H시 %M분') }}</p>
            {% endif %}
            <p class="text-gray-700 text-sm mb-2"><strong>사유:</strong> {{ schedule.reason }}</p>
            <p class="text-gray-700 text-sm"><strong>상태:</strong> {{ schedule.status }}</p>
        </div>

        {# 증거 파일이 업로드되었거나, 관리자일 경우 증거 파일을 보여줌 #}
        {% if schedule.evidence_uploaded or user_role == 'owner' %}
            <div class="bg-blue-100 p-4 rounded-lg text-blue-700 text-center font-medium mb-6">
                {% if user_role == 'sub' %}
                    이미 증거가 업로드된 일정입니다. 관리자의 확인을 기다려주세요.
                {% else %} {# user_role == 'owner' #}
                    이 일정의 증거 파일입니다.
                {% endif %}
            </div>
            {% if schedule.evidence_filenames %}
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">업로드된 증거 파일:</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {% for filename in schedule.evidence_filenames %}
                            <div class="border rounded-lg overflow-hidden shadow-sm">
                                {% if filename.split('.')[-1] in ['mp4', 'mov', 'avi'] %}
                                    <video controls class="w-full h-32 object-cover rounded-t-lg">
                                        <source src="{{ url_for('uploaded_file', filename=filename) }}" type="video/{{ filename.split('.')[-1] }}">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="증거 이미지" class="w-full h-32 object-cover rounded-t-lg">
                                {% endif %}
                                <div class="p-2 text-center text-xs text-gray-600 truncate">
                                    <a href="{{ url_for('uploaded_file', filename=filename) }}" target="_blank" class="text-blue-500 hover:underline">
                                        {{ filename }}
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="bg-yellow-100 p-4 rounded-lg text-yellow-700 text-center font-medium">
                    업로드된 증거 파일이 없습니다.
                </div>
            {% endif %}
            {# 관리자일 경우 업로드 폼을 숨김: user_role이 sub일 때만 폼을 보여줌 #}
            {% if user_role == 'sub' and (schedule.status == 'approved' or schedule.status == 'rescheduled') %}
                <form action="{{ url_for('upload_punishment_evidence', schedule_id=schedule.id) }}" method="post" enctype="multipart/form-data" class="space-y-6">
                    <div>
                        <label for="evidence_files" class="block text-lg font-medium text-gray-700 mb-2">
                            증거 파일 업로드 (최소 3개 이상의 사진 또는 동영상)
                        </label>
                        <input type="file" name="evidence_files" id="evidence_files" multiple accept="image/*,video/*"
                               class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                        <p class="mt-1 text-sm text-gray-500">사진 (png, jpg, jpeg, gif) 또는 동영상 (mp4, mov, avi) 파일을 업로드하세요.</p>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                        증거 업로드
                    </button>
                </form>
            {% endif %}
        {# 증거가 업로드되지 않았고, 댕댕이면서 승인/연기 요청 상태일 때만 업로드 폼 보여줌 #}
        {% elif user_role == 'sub' and (schedule.status == 'approved' or schedule.status == 'rescheduled') %}
            <form action="{{ url_for('upload_punishment_evidence', schedule_id=schedule.id) }}" method="post" enctype="multipart/form-data" class="space-y-6">
                <div>
                    <label for="evidence_files" class="block text-lg font-medium text-gray-700 mb-2">
                        증거 파일 업로드 (최소 3개 이상의 사진 또는 동영상)
                    </label>
                    <input type="file" name="evidence_files" id="evidence_files" multiple accept="image/*,video/*"
                           class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    <p class="mt-1 text-sm text-gray-500">사진 (png, jpg, jpeg, gif) 또는 동영상 (mp4, mov, avi) 파일을 업로드하세요.</p>
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                    증거 업로드
                </button>
            </form>
        {% else %}
            <div class="bg-yellow-100 p-4 rounded-lg text-yellow-700 text-center font-medium">
                이 일정은 현재 증거를 업로드할 수 있는 상태가 아닙니다 (상태: {{ schedule.status }}).
            </div>
        {% endif %}
    {% else %}
        <div class="bg-red-100 p-4 rounded-lg text-red-700 text-center font-medium">
            유효한 체벌/교육 일정이 선택되지 않았습니다.
        </div>
    {% endif %}

    <div class="mt-8 text-center">
        <a href="{{ url_for('home') }}" class="inline-block text-blue-600 hover:underline font-medium">홈으로</a>
    </div>
</div>
{% endblock %}
