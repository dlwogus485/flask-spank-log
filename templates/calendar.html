{% extends "base.html" %}

{% block title %}캘린더 보기{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-3xl mx-auto">
  <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">캘린더 보기</h2>

  <div class="mb-8 p-6 border rounded-lg bg-gray-50">
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonth" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600">&lt; 이전 달</button>
      <h3 id="currentMonthYear" class="text-xl font-semibold"></h3>
      <button id="nextMonth" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600">다음 달 &gt;</button>
    </div>
    <div class="grid grid-cols-7 text-center font-bold text-gray-700 mb-2">
      <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
    </div>
    <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
  </div>

  <div class="p-6 border rounded-lg bg-gray-50">
    <h3 class="text-xl font-semibold mb-4" id="selectedDateEventsHeader">선택된 날짜의 기록</h3>
    <ul id="selectedDateEventsList" class="space-y-4">
      <li class="text-center text-gray-600">날짜를 선택해주세요.</li>
    </ul>
  </div>

  <div class="mt-8 text-center">
    <a href="{{ url_for('home') }}" class="text-blue-600 hover:underline">홈으로</a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthYearHeader = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const selectedDateEventsHeader = document.getElementById('selectedDateEventsHeader');
    const selectedDateEventsList = document.getElementById('selectedDateEventsList');

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    const eventsData = {
        reports: {{ reports | tojson | safe }},
        penalties: {{ penalties | tojson | safe }},
        schedules: {{ punishment_schedules | tojson | safe }},
        resets: {{ penalty_reset_history | tojson | safe }},
        payments: {{ payments | tojson | safe }},
        cardio_logs: {{ cardio_logs | tojson | safe }},
        weight_entries: {{ weight_entries | tojson | safe }}
    };

    const eventsByDate = {}; 

    const organizeDataByDate = () => {
        const process = (items, dateField, type) => {
            if (!items) return;
            items.forEach(item => {
                const date = new Date(item[dateField]);
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                if (!eventsByDate[dateKey]) eventsByDate[dateKey] = {};
                if (!eventsByDate[dateKey][type]) eventsByDate[dateKey][type] = [];
                eventsByDate[dateKey][type].push(item);
            });
        };
        process(eventsData.reports, 'timestamp', 'reports');
        process(eventsData.penalties, 'timestamp', 'penalties');
        process(eventsData.schedules, 'requested_datetime', 'schedules');
        process(eventsData.resets, 'reset_date', 'resets');
        process(eventsData.payments, 'timestamp', 'payments');
        process(eventsData.cardio_logs, 'date', 'cardio_logs');
        process(eventsData.weight_entries, 'timestamp', 'weight_entries');
    };
    
    organizeDataByDate();

    function renderCalendar() {
      calendarGrid.innerHTML = ''; 
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const startingDayOfWeek = firstDayOfMonth.getDay(); 
      currentMonthYearHeader.textContent = `${currentYear}년 ${currentMonth + 1}월`;

      for (let i = 0; i < startingDayOfWeek; i++) { calendarGrid.appendChild(document.createElement('div')); }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayCell = document.createElement('div');
        dayCell.classList.add('p-2', 'text-center', 'rounded-md', 'cursor-pointer', 'min-h-[80px]'); 
        dayCell.textContent = day;
        dayCell.dataset.date = dateKey; 
        const dayEvents = eventsByDate[dateKey];
        if (dayEvents) {
            if (dayEvents.schedules) dayCell.classList.add('bg-pink-200');
            if (dayEvents.penalties) dayCell.classList.add('bg-red-200');
            if (dayEvents.reports && dayEvents.reports.some(r => r.is_holiday)) dayCell.classList.add('bg-gray-200');
        }
        if (new Date(dateKey).toDateString() === new Date().toDateString()) dayCell.classList.add('ring-2', 'ring-blue-500');
        dayCell.addEventListener('click', () => {
          displayEventsForDate(dateKey);
          document.querySelectorAll('.calendar-day-selected').forEach(el => el.classList.remove('calendar-day-selected', 'bg-blue-300'));
          dayCell.classList.add('calendar-day-selected', 'bg-blue-300');
        });
        calendarGrid.appendChild(dayCell);
      }
    }

    function displayEventsForDate(dateKey) {
        selectedDateEventsHeader.textContent = `${dateKey}의 기록`;
        selectedDateEventsList.innerHTML = ''; 
        const events = eventsByDate[dateKey];
        let hasContent = false;

        const createListItem = (className, content) => {
            const li = document.createElement('li');
            li.className = `p-3 rounded-lg ${className}`;
            li.innerHTML = content;
            selectedDateEventsList.appendChild(li);
            hasContent = true;
        };

        if (events) {
            if (events.schedules) events.schedules.forEach(s => {
                const statusMap = {'pending': '대기', 'approved': '예정', 'completed': '완료', 'evidence_uploaded': '증거 확인중', 'rejected': '거절', 'rescheduled': '연기 요청'};
                createListItem('bg-pink-100', `<p class="font-semibold text-pink-700">체벌/교육 ${statusMap[s.status] || s.status}</p><p class="text-sm mt-1">${s.reason}</p>`);
            });
            if (events.resets) events.resets.forEach(pr => createListItem('bg-teal-100', `<p class="font-semibold text-teal-700">벌점 리셋</p><p class="text-sm mt-1">${pr.reset_points}점 (사유: ${pr.reset_reason})</p>`));
            if (events.penalties) events.penalties.forEach(p => createListItem('bg-red-100', `<p class="font-semibold text-red-700">벌점: ${p.penalty_type}</p><p class="text-sm mt-1">${p.penalty_points}점 (사유: ${p.reason || '없음'})</p>`));
            if (events.cardio_logs) events.cardio_logs.forEach(c => createListItem('bg-orange-100', `<p class="font-semibold text-orange-700">유산소 운동 인증</p>`));
            if (events.payments) events.payments.forEach(p => createListItem('bg-purple-100', `<p class="font-semibold text-purple-700">소액결제</p><p class="text-sm mt-1">${p.description || '내역 없음'} - ${p.amount.toLocaleString()}원</p>`));
            if (events.weight_entries) events.weight_entries.forEach(w => createListItem('bg-yellow-100', `<p class="font-semibold text-yellow-700">체중 기록</p><p class="text-sm mt-1">${w.weight_kg} kg</p>`));
            if (events.reports) events.reports.forEach(r => {
                if(r.is_holiday) createListItem('bg-gray-100', `<p class="font-semibold text-gray-700">✅ 휴무일</p>`);
                else createListItem('bg-green-100', `<p class="font-semibold text-green-700">출근인증 ${r.is_late ? '<span class="text-red-500">(지각)</span>' : ''}</p><p class="text-sm mt-1">${r.content}</p>`);
            });
        }
      
        if (!hasContent) {
            selectedDateEventsList.innerHTML = '<li class="text-center text-gray-600">이 날짜에는 기록이 없습니다.</li>';
        }
    }

    prevMonthBtn.addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); });
    nextMonthBtn.addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); });
    renderCalendar();
  });
</script>
{% endblock %}

